<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to use fastai tabular with custom metric | Data Science Blog von lschmiddey</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="How to use fastai tabular with custom metric" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:url" content="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:site_name" content="Data Science Blog von lschmiddey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-01T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-10-01T00:00:00-05:00","headline":"How to use fastai tabular with custom metric","mainEntityOfPage":{"@type":"WebPage","@id":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html"},"@type":"BlogPosting","url":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html","dateModified":"2020-10-01T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/fastpages_/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://lschmiddey.github.io/fastpages_/feed.xml" title="Data Science Blog von lschmiddey" /><link rel="shortcut icon" type="image/x-icon" href="/fastpages_/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to use fastai tabular with custom metric | Data Science Blog von lschmiddey</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="How to use fastai tabular with custom metric" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:url" content="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:site_name" content="Data Science Blog von lschmiddey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-01T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-10-01T00:00:00-05:00","headline":"How to use fastai tabular with custom metric","mainEntityOfPage":{"@type":"WebPage","@id":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html"},"@type":"BlogPosting","url":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html","dateModified":"2020-10-01T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://lschmiddey.github.io/fastpages_/feed.xml" title="Data Science Blog von lschmiddey" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/fastpages_/">Data Science Blog von lschmiddey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/fastpages_/about/">About Me</a><a class="page-link" href="/fastpages_/search/">Search</a><a class="page-link" href="/fastpages_/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to use fastai tabular with custom metric</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-10-01T00:00:00-05:00" itemprop="datePublished">
        Oct 1, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/lschmiddey/fastpages_/tree/master/_notebooks/2020-10-01-Tabular-Data-with-custom-metric.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/fastpages_/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/lschmiddey/fastpages_/master?filepath=_notebooks%2F2020-10-01-Tabular-Data-with-custom-metric.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/fastpages_/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/lschmiddey/fastpages_/blob/master/_notebooks/2020-10-01-Tabular-Data-with-custom-metric.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/fastpages_/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-10-01-Tabular-Data-with-custom-metric.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-easily-train-a-tabular-model-with-fastai">How to easily train a tabular model with fastai<a class="anchor-link" href="#How-to-easily-train-a-tabular-model-with-fastai"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, we have to load our data (I used the kaggle API to do this, check out my previous <a href="https://lschmiddey.github.io/fastpages_/2020/09/15/get-kaggle-api-started.html">blogpost</a>)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/notebooks/storage/data/Titanic&#39;</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/notebooks/storage/data/Titanic/titanic.zip&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>unzip -q <span class="o">{</span>str<span class="o">(</span>filename<span class="o">)}</span> -d <span class="o">{</span>str<span class="o">(</span>p/<span class="s2">&quot;train&quot;</span><span class="o">)}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Get-imports">Get imports<a class="anchor-link" href="#Get-imports"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_string_dtype</span><span class="p">,</span> <span class="n">is_numeric_dtype</span><span class="p">,</span> <span class="n">is_categorical_dtype</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/train/train.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
    <tr>
      <th>PassengerId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>887</th>
      <td>0</td>
      <td>2</td>
      <td>Montvila, Rev. Juozas</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>211536</td>
      <td>13.00</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>888</th>
      <td>1</td>
      <td>1</td>
      <td>Graham, Miss. Margaret Edith</td>
      <td>female</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>112053</td>
      <td>30.00</td>
      <td>B42</td>
      <td>S</td>
    </tr>
    <tr>
      <th>889</th>
      <td>0</td>
      <td>3</td>
      <td>Johnston, Miss. Catherine Helen "Carrie"</td>
      <td>female</td>
      <td>NaN</td>
      <td>1</td>
      <td>2</td>
      <td>W./C. 6607</td>
      <td>23.45</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>890</th>
      <td>1</td>
      <td>1</td>
      <td>Behr, Mr. Karl Howell</td>
      <td>male</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>111369</td>
      <td>30.00</td>
      <td>C148</td>
      <td>C</td>
    </tr>
    <tr>
      <th>891</th>
      <td>0</td>
      <td>3</td>
      <td>Dooley, Mr. Patrick</td>
      <td>male</td>
      <td>32.0</td>
      <td>0</td>
      <td>0</td>
      <td>370376</td>
      <td>7.75</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(891, 11)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's check out the data type for each column.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Survived      int64
Pclass        int64
Name         object
Sex          object
Age         float64
SibSp         int64
Parch         int64
Ticket       object
Fare        float64
Cabin        object
Embarked     object
dtype: object</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We see that "Pclass", "Sex", "Cabin" and "Embarked" are objects. When we think about these variables, they clearly are categorical variables. So let's change that. Also, this blogpost is not about how to train the best possible model, so we do not want any fancy feature engineering. I therefore will get rid of the variable "Name".</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Cabin&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Cabin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I want to build a validation set, based on the index. The easiest way is to create an array with the length of our data, randomly select a percentage of indeces we want in our training data, and use the leftover indeces for our validation set.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Define percentage of train data, define length of training indeces and validation indeces</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">len_df</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">len_idx_tain</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">len_df</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="n">len_idx_val</span> <span class="o">=</span> <span class="n">len_df</span><span class="o">-</span><span class="n">len_idx_tain</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># build array of indeces for training and validation</span>
<span class="n">idx_arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_df</span><span class="p">)</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_df</span><span class="p">),</span> <span class="n">len_idx_tain</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">val_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_arr</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">train_idx</span><span class="p">]</span>
<span class="n">val_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val_idx</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's put these arrays into a split variable, which fastai knows how to make use of to split the data into training data and validation data.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_idx</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">val_idx</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we make use of the "cont_cat_split" function to easily get a list of column names for each categorical and continuous variable.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cont_nn</span><span class="p">,</span> <span class="n">cat_nn</span> <span class="o">=</span> <span class="n">cont_cat_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="s1">&#39;Survived&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cont_nn</span><span class="p">,</span> <span class="n">cat_nn</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>([&#39;Age&#39;, &#39;Fare&#39;],
 [&#39;Pclass&#39;, &#39;Sex&#39;, &#39;SibSp&#39;, &#39;Parch&#39;, &#39;Ticket&#39;, &#39;Cabin&#39;, &#39;Embarked&#39;])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That looks great! How about our missing values?</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Survived      0
Pclass        0
Sex           0
Age         177
SibSp         0
Parch         0
Ticket        0
Fare          0
Cabin       687
Embarked      2
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looks like there are quite a few missing values for age and cabin. But we know a way to make use of that! Even "no-information" can be an information.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">procs_nn</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fastai provides us with many super useful out-of-the-box functions. Three of them you can see here: Categorify will take all of the variables with type "category" will replace the category with a numerical number and write the mapping into a dictionary. FillMissing, well, does exactly this. It also provides us with a extra boolean variable, indicating whether the row has a missing value for a specific variable (e.g. age). Normalize then normalizes our continuous data and saves the standardzier.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This one is important: fastai needs the dependend variable to be of type float32, even though we have a binary classification! We need this, because the loss function will be mse-loss. This leads to possibly odd behavior: the numbers can get below 0 and even below -1 or above 2! If we use a provided metric like accuracy, this leads to odd results. So we will write our own custom metric! But first, let's use the TabularPandas class and put that in a dataloader (important: do not let the batchsize become bigger than your data, this will result in a error!).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">to_nn</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">procs_nn</span><span class="p">,</span> <span class="n">cat_nn</span><span class="p">,</span> <span class="n">cont_nn</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="s1">&#39;Survived&#39;</span><span class="p">)</span>
<span class="c1"># length of data is 891, so let the batchsize be smaller than that!</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">to_nn</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Train-Model">Train Model<a class="anchor-link" href="#Train-Model"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now is the time to train our model. But wait! We first have to define a custom metric, because the accuracy provided by fastai will lead to odd results. I can show you what I mean:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.562715</td>
      <td>0.504298</td>
      <td>0.617977</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.498489</td>
      <td>0.477128</td>
      <td>0.617977</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.436740</td>
      <td>0.448243</td>
      <td>0.617977</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.391733</td>
      <td>0.423635</td>
      <td>0.617977</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What is going on here? Is the accuracy not improving? The answer is no. Tabular learner in combination with accuracy does not give us the result we want. Why is that? First, our predictions will not be 0 or 1, but floating point values. That's good for our loss, so our model can learn from its gradient (checkout my blogpost about <a href="https://lschmiddey.github.io/fastpages_/2020/09/01/Gradient-Descent.html">gradients</a> if you do not know what that means). But this leads to a malfunctioning of the accuracy metric, which fastai uses from sklearn. What we need to do is to define our own custom metric. Let's do that!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn.metrics</span> <span class="k">as</span> <span class="nn">skm</span>
 
<span class="k">def</span> <span class="nf">_accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
    <span class="c1">#pred = learn.pred.argmax(dim=self.dim_argmax) if self.dim_argmax else learn.pred</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">pred</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">y</span>
    <span class="n">pred</span><span class="p">,</span><span class="n">targ</span> <span class="o">=</span> <span class="n">to_detach</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span><span class="n">to_detach</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">targs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>

<span class="n">AccumMetric</span><span class="o">.</span><span class="n">accumulate</span> <span class="o">=</span> <span class="n">_accumulate</span>

<span class="k">def</span> <span class="nf">BinAccu</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">skm_to_fastai</span><span class="p">(</span><span class="n">skm</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So what's going on here? Next to Callbacks, fastai provides a clever way how to customize metrics. To be honest, it took me some time to figure it out, but here's how it works. Each learner has a .pred and a .y, which means this is how you can get its predictions and its targets. As I already mentioned, preds are floating point values, but we want them to be between 0 and 1 - luckily, this is exactly what the sigmoid function is doing. Then we want the values to be either 0 or 1, so let's just round these values (threshold here is .5, but you can fiddle around with that). We then append these "new" preds and targets.</p>
<p>"In order to provide a more flexible foundation to support metrics like this fastai provides a Metric abstract class which defines three methods: reset, accumulate, and value (which is a property). Reset is called at the start of training, accumulate is called after each batch, and then finally value is called to calculate the final check."</p>
<p>So with this function we directly sit on top of accumulate. The function skm_to_fastai let's you use sklearn metrics (in this case: accuracy_score) and uses the pred and targ we provided in our tiny function. Important: we have to instanciate the instance first!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binaccu</span> <span class="o">=</span> <span class="n">BinAccu</span><span class="p">()</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">binaccu</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok, we're good to go. Let's use fastai's awesome lr_find().</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(lr_min=0.03630780577659607, lr_steep=0.0010000000474974513)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looks like we should set our learning rate to about 1e-3.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.484679</td>
      <td>0.372455</td>
      <td>0.325843</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.425642</td>
      <td>0.374143</td>
      <td>0.595506</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.343880</td>
      <td>0.367273</td>
      <td>0.494382</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.271155</td>
      <td>0.349920</td>
      <td>0.393258</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.220030</td>
      <td>0.334517</td>
      <td>0.382022</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.184440</td>
      <td>0.325883</td>
      <td>0.382022</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.157990</td>
      <td>0.319556</td>
      <td>0.382022</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.137255</td>
      <td>0.313525</td>
      <td>0.382022</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.120796</td>
      <td>0.309076</td>
      <td>0.382022</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.107582</td>
      <td>0.306098</td>
      <td>0.382022</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our accuracy is improving until epoch 2. So we should restart our training. But first, let's have a look, whether our accuracy score is doing what we expect:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<span class="n">confusion_matrix</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0,  0],
       [55, 34]])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="mi">1</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.3820)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Awesome. That's exactly what we wanted (not the result though, which is pretty bad ;) )</p>
<p>Let's re-run the trainig.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binaccu</span> <span class="o">=</span> <span class="n">BinAccu</span><span class="p">()</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">binaccu</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.616267</td>
      <td>0.422966</td>
      <td>0.617978</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.610159</td>
      <td>0.418977</td>
      <td>0.617978</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.607095</td>
      <td>0.416566</td>
      <td>0.617978</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.604457</td>
      <td>0.414736</td>
      <td>0.629213</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.604596</td>
      <td>0.413118</td>
      <td>0.640449</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<span class="n">confusion_matrix</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[54, 31],
       [ 1,  3]])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To be honest, the results aren't quite that good. With a RandomForest you can easily get up to 85% accuracy. However, in this blogpost I wanted to show you how to leverage fastai's tabular_learner and add a custom metric to it.</p>
<p>I hope you stay tuned for the next blogpost!</p>
<p>Lasse</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/fastpages_/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/fastpages_/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/fastpages_/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/lschmiddey" target="_blank" title="lschmiddey"><svg class="svg-icon grey"><use xlink:href="/fastpages_/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
