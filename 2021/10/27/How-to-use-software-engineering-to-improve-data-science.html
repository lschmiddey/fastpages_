<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to use Software Engineering to improve Data Science Code | Data Science Blog von lschmiddey</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="How to use Software Engineering to improve Data Science Code" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html" />
<meta property="og:url" content="https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html" />
<meta property="og:site_name" content="Data Science Blog von lschmiddey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-27T00:00:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"How to use Software Engineering to improve Data Science Code","dateModified":"2021-10-27T00:00:00-05:00","datePublished":"2021-10-27T00:00:00-05:00","url":"https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/fastpages_/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://lschmiddey.github.io/fastpages_/feed.xml" title="Data Science Blog von lschmiddey" /><link rel="shortcut icon" type="image/x-icon" href="/fastpages_/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to use Software Engineering to improve Data Science Code | Data Science Blog von lschmiddey</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="How to use Software Engineering to improve Data Science Code" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html" />
<meta property="og:url" content="https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html" />
<meta property="og:site_name" content="Data Science Blog von lschmiddey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-27T00:00:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"How to use Software Engineering to improve Data Science Code","dateModified":"2021-10-27T00:00:00-05:00","datePublished":"2021-10-27T00:00:00-05:00","url":"https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://lschmiddey.github.io/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://lschmiddey.github.io/fastpages_/feed.xml" title="Data Science Blog von lschmiddey" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/fastpages_/">Data Science Blog von lschmiddey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/fastpages_/about/">About Me</a><a class="page-link" href="/fastpages_/search/">Search</a><a class="page-link" href="/fastpages_/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to use Software Engineering to improve Data Science Code</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-10-27T00:00:00-05:00" itemprop="datePublished">
        Oct 27, 2021
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/lschmiddey/fastpages_/tree/master/_notebooks/2021-10-27-How-to-use-software-engineering-to-improve-data-science.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/fastpages_/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/lschmiddey/fastpages_/master?filepath=_notebooks%2F2021-10-27-How-to-use-software-engineering-to-improve-data-science.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/fastpages_/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/lschmiddey/fastpages_/blob/master/_notebooks/2021-10-27-How-to-use-software-engineering-to-improve-data-science.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/fastpages_/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-10-27-How-to-use-software-engineering-to-improve-data-science.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Why-Data-Science-has-to-stop-producing-Spaghetti-Code">Why Data Science has to stop producing Spaghetti Code<a class="anchor-link" href="#Why-Data-Science-has-to-stop-producing-Spaghetti-Code"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a common Data Scientist, I know the pain. Usually, what we do is pretty straight forward processwise, but somehow this almost always end up with a code that has become so complex, it's hard to keep track. Moreover, most Data Scientist do not really care about Software Engineering and use functions and classes all over the place, without any proper thinking about it first. Admittedly, I also did code like that.</p>
<p>For some time now I wanted to change this. After reading some books and articles about Software Engineering and watching a ton of YouTube tutorials on it (thanks so much internet!) I came up with a few ideas how every Data Scientist can and should improve her code. Let's start with the basic design pattern I found helpful for each of my Data Science projects.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="The-Information-Expert-Principle">The Information Expert Principle<a class="anchor-link" href="#The-Information-Expert-Principle"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This principle is pretty straightforward, but when applying it from the start of your project it will help you a lot writing cleaner and more beautiful code. It means that the design of your software (which, in the end, is what we are writing) should follow the data pipeline. What does this mean in action? Let me give you a brief example:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">BaseData</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1">/ItalyPowerDemand_TRAIN.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1">/ItalyPowerDemand_TEST.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_fake_cat_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes dataframe as input and transforms data&quot;&quot;&quot;</span>
        <span class="c1"># let&#39;s add a categorical variable</span>
        <span class="n">countries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Germany&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">]</span>
        <span class="n">household_income</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">countries</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">countries</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;household_income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">household_income</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;household_income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">household_income</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transform_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emb_vars_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emb_vars_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">def</span> <span class="nf">categorize_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emb_vars_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_vars_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_embs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_inv_embs</span> <span class="o">=</span> \
            <span class="n">cat_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emb_vars_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_vars_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_data</span> <span class="o">=</span> <span class="n">BaseData</span><span class="p">()</span>
<span class="n">base_data</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">base_data</span><span class="o">.</span><span class="n">make_fake_cat_vars</span><span class="p">()</span>
<span class="n">base_data</span><span class="o">.</span><span class="n">transform_data</span><span class="p">()</span>
<span class="n">base_data</span><span class="o">.</span><span class="n">categorize_variables</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_data</span><span class="o">.</span><span class="n">df_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>20</th>
      <th>21</th>
      <th>22</th>
      <th>23</th>
      <th>24</th>
      <th>country</th>
      <th>household_income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>-0.710518</td>
      <td>-1.183320</td>
      <td>-1.372442</td>
      <td>-1.593083</td>
      <td>-1.467002</td>
      <td>-1.372442</td>
      <td>-1.088760</td>
      <td>0.045967</td>
      <td>0.928532</td>
      <td>...</td>
      <td>-0.206195</td>
      <td>0.613330</td>
      <td>1.369815</td>
      <td>1.464375</td>
      <td>1.054613</td>
      <td>0.581810</td>
      <td>0.172048</td>
      <td>-0.269235</td>
      <td>Germany</td>
      <td>low</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>-0.993009</td>
      <td>-1.426786</td>
      <td>-1.579884</td>
      <td>-1.605401</td>
      <td>-1.630917</td>
      <td>-1.375754</td>
      <td>-1.018526</td>
      <td>-0.355102</td>
      <td>0.716583</td>
      <td>...</td>
      <td>0.614518</td>
      <td>0.308322</td>
      <td>0.257289</td>
      <td>1.099327</td>
      <td>1.048295</td>
      <td>0.691066</td>
      <td>-0.048906</td>
      <td>-0.380618</td>
      <td>Germany</td>
      <td>high</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>1.319067</td>
      <td>0.569774</td>
      <td>0.195128</td>
      <td>-0.085856</td>
      <td>-0.179518</td>
      <td>-0.273180</td>
      <td>-0.085856</td>
      <td>-1.397118</td>
      <td>-1.116134</td>
      <td>...</td>
      <td>-0.741487</td>
      <td>-0.741487</td>
      <td>-1.116134</td>
      <td>-0.460503</td>
      <td>0.476113</td>
      <td>2.349344</td>
      <td>2.255682</td>
      <td>1.600052</td>
      <td>Germany</td>
      <td>low</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.0</td>
      <td>-0.812444</td>
      <td>-1.157553</td>
      <td>-1.416385</td>
      <td>-1.531421</td>
      <td>-1.502662</td>
      <td>-1.416385</td>
      <td>-1.646458</td>
      <td>-0.467335</td>
      <td>0.654269</td>
      <td>...</td>
      <td>0.884342</td>
      <td>0.683028</td>
      <td>0.625510</td>
      <td>0.424197</td>
      <td>-0.007190</td>
      <td>-0.035949</td>
      <td>0.107847</td>
      <td>-0.266022</td>
      <td>Germany</td>
      <td>low</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>-0.972840</td>
      <td>-1.390518</td>
      <td>-1.536705</td>
      <td>-1.620240</td>
      <td>-1.620240</td>
      <td>-1.453169</td>
      <td>-0.993724</td>
      <td>0.050469</td>
      <td>0.635218</td>
      <td>...</td>
      <td>0.614334</td>
      <td>1.303502</td>
      <td>1.240850</td>
      <td>1.073779</td>
      <td>0.551682</td>
      <td>0.426379</td>
      <td>-0.179253</td>
      <td>-0.638698</td>
      <td>Germany</td>
      <td>low</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 27 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_data</span><span class="o">.</span><span class="n">dict_embs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{0: &#39;US&#39;, 1: &#39;Germany&#39;}, {0: &#39;low&#39;, 1: &#39;high&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_data</span><span class="o">.</span><span class="n">emb_vars_train</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[1, 1],
       [1, 0],
       [1, 0],
       [1, 0],
       [0, 0],
       [1, 1],
       [1, 1],
       [0, 0],
       [1, 0]])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What happens here is that everything connected to the data is now stored in the BaseData class. Each and every function within this class needs the data where it is and gets the data directly, so there is no jumping to other objects or methods to make this happen. So my first take away: keep your data together!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next I will use this data to pass it on to the next point within our pipeline. Just to keep you informed, what I do here is actually a refactoring of an earlier project of mine, where I will use a convolutional neural network in PyTorch to classify a timeseries. So in order to use PyTorches power, the data needs to be in so called Dataloaders.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dataloaders</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">DEVICE</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">create_datasets</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="n">base_data</span><span class="o">.</span><span class="n">emb_vars_train</span><span class="p">,</span> <span class="n">base_data</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
             <span class="n">base_data</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span> <span class="n">base_data</span><span class="o">.</span><span class="n">emb_vars_test</span><span class="p">,</span> <span class="n">base_data</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span>
             <span class="n">valid_pct</span><span class="o">=</span><span class="n">VAL_SIZE</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">DataBunch</span><span class="p">(</span><span class="o">*</span><span class="n">create_loaders</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1024</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you want to have a closer look at what this exactly does, just go inside the dataloaders.py file. Basically it splits the train_data into train and validation and then creates a PyTorch dataset from it. This then can be put into a dataloader. Now I could have used three different dataloaders, but again, I want to keep my data together, which is why I created a class called DataBunch (naming and idea stolen from fastai), where I have all of my data in one place.</p>
<p>Furthermore, realize that I use one, and only one config file. I often see Code with different kind of constants aka configurations all over different files, which makes it extremely hard to later on debug the code or change settings. So please keep your constants in one place.</p>
<p>Now let's have a closer how we can use a clever way of building models in a more flexible way:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="k">class</span> <span class="nc">Flatten</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts N-dimensional tensor into &#39;flat&#39; one.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_batch_dim</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_batch_dim</span> <span class="o">=</span> <span class="n">keep_batch_dim</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_batch_dim</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">conv1d</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">nf</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">get_cnn_layers</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">output_shapes</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">kernels</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">strides</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">drop</span><span class="o">=.</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">output_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_shape</span><span class="p">]</span> <span class="o">+</span> <span class="n">output_shapes</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">conv1d</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output_shapes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">MaxPool1d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">Flatten</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>


<span class="k">class</span> <span class="nc">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model Baseclass.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conv_layers</span><span class="p">,</span> <span class="n">emb_dims</span><span class="p">,</span> <span class="n">no</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">conv_layers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">emb_dims</span><span class="p">])</span>
        <span class="n">no_of_embs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">emb_dims</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_of_embs</span> <span class="o">=</span> <span class="n">no_of_embs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emb_dims</span> <span class="o">=</span> <span class="n">emb_dims</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emb_out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">no_of_embs</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">no</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_raw</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">):</span>  <span class="c1"># this is where the data flows in later in the training</span>
        <span class="n">raw_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">t_raw</span><span class="p">)</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="p">[</span><span class="n">emb_layer</span><span class="p">(</span><span class="n">embeddings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">emb_layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">)]</span>
        <span class="c1"># we want to concatenate convolutions and embeddings. Embeddings are of size (batch_size, no_of_embs),</span>
        <span class="c1"># convolution of size (batch, 256, 1) so we need to add another dimension to the embeddings at dimension 2 (</span>
        <span class="c1"># counting starts from 0)</span>
        <span class="n">emb_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">emb_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_out</span><span class="p">(</span><span class="n">emb_cat</span><span class="p">)</span>
        <span class="n">t_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">raw_out</span><span class="p">,</span> <span class="n">emb_cat</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First thing to notice here is that I combined the basic structure of a Conv1d layer in one function. Every Conv1d layer should have a BatchNorm followed by a ReLU. You can adjust this just as you like. Then, in the next step I created a function which basically makes the Conv1d layer repetitive, given a list of arguments you provide. So based on that list of arguments, you can have 1, 2, 3, 4 or as many layer as you would like. This then in turn is then used in the Classifier class, which is our main model. The convolutional part, here called <em>self.raw</em> is then build given on what we specify how the architecture should look like. The rest of the model I kept rather inflexible, which you could if you want also change. But let's see this in action:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>

<span class="n">raw_feat</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">emb_dims</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">dict_embs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">EMB_DIMS</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">dict_embs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">EMB_DIMS</span><span class="p">)]</span>

<span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># model layers</span>
<span class="n">OUTPUT_SHAPES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span>
<span class="n">KERNELS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<span class="n">STRIDES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="o">*</span><span class="n">get_cnn_layers</span><span class="p">(</span><span class="n">raw_feat</span><span class="p">,</span> <span class="n">OUTPUT_SHAPES</span><span class="p">,</span> <span class="n">KERNELS</span><span class="p">,</span> <span class="n">STRIDES</span><span class="p">)</span>
    <span class="p">),</span> <span class="n">emb_dims</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Everything written in all caps is actually defined within the config file, but for seeing what's going on here I just put them into this code snippet. So if I wanted to add another layer, I could just go into my config file and change that, so that I have three layers with different kernels and strides. When doing experiments, you can just provide different settings in your config and then use them for your second model. Do not underestimate the idea of having parameters in one place.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The next big part is directly connected to the Information Expert principle. Let's start with the Learner, a simple idea based on that principle. When training the model, we need another class which keeps all the information needed, the Learner. And what information does the Learner need? The data, the model, the loss function and the optimizer:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Learner</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">loss_func</span><span class="p">,</span><span class="n">data</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we need to build the pipeline for our process, let's call it runner. We pass in the Learner, which is responsible for the data and modelling part. The runner itself only guides the data flow:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Runner</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cb_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_train</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cbs</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">cbs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cbf</span> <span class="ow">in</span> <span class="n">listify</span><span class="p">(</span><span class="n">cb_funcs</span><span class="p">):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">cbf</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
            <span class="n">cbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,[</span><span class="n">TrainEvalCallback</span><span class="p">()]</span><span class="o">+</span><span class="n">cbs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">opt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loss_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">loss_func</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">one_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">yb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="p">,</span><span class="n">emb</span><span class="p">,</span><span class="n">yb</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;begin_batch&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">emb</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_pred&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yb</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_loss&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_train</span><span class="p">:</span> <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_backward&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_step&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">CancelBatchException</span><span class="p">:</span> <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_cancel_batch&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span> <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_batch&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">all_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">emb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_batch</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CancelEpochException</span><span class="p">:</span> <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_cancel_epoch&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">epochs</span><span class="p">,</span><span class="n">learn</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="p">:</span> <span class="n">cb</span><span class="o">.</span><span class="n">set_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;begin_fit&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_batches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_dl</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_batches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">valid_dl</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_epoch&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">CancelTrainException</span><span class="p">:</span> <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_cancel_train&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;after_fit&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_name</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">_order</span><span class="p">):</span> <span class="n">res</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">cb_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The last idea I want every Data Scientist to know about are Callbacks. Basically that means we're calling a different function and make use of their behaviour. To be able to clearly pinpoint where the Callback should be applied, I added things like <em>self('after_epoch')</em>. This then let's us easily create our own Callbacks which we can use exactly where we want to:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">class</span> <span class="nc">Callback</span><span class="p">():</span>
    <span class="n">_order</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">set_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">=</span><span class="n">run</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Callback$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">camel2snake</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;callback&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_name</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">f</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">Recorder</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">begin_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">after_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_train</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">pg</span><span class="p">,</span><span class="n">lr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="p">):</span> <span class="n">lr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">plot_lr</span>  <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pgid</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="p">[</span><span class="n">pgid</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">plot_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span><span class="o">-</span><span class="n">skip_last</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pgid</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">]</span>
        <span class="n">lrs</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="p">[</span><span class="n">pgid</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">-</span><span class="n">skip_last</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lrs</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">losses</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">LR_Find</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="n">_order</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">max_lr</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">min_lr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span> <span class="o">=</span> <span class="n">max_iter</span><span class="p">,</span><span class="n">min_lr</span><span class="p">,</span><span class="n">max_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span> <span class="o">=</span> <span class="mf">1e9</span>

    <span class="k">def</span> <span class="nf">begin_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_train</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_lr</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">min_lr</span><span class="p">)</span> <span class="o">**</span> <span class="n">pos</span>
        <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span> <span class="n">pg</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>

    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="o">*</span><span class="mi">10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CancelTrainException</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After creating the base Callback class, each and every Callback we want to use inherits from it. Take the LR_Find Callback: This will be applied after a batch begins and after each step. These we have defined within our Runner class. Now we can use these Callbacks like so:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">callbacks</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span><span class="n">cb_funcs</span><span class="o">=</span><span class="p">[</span><span class="n">LR_Find</span><span class="p">,</span> <span class="n">Recorder</span><span class="p">])</span>

<span class="n">run</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">learn</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">skip_last</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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" />
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can add all sorts of Callbacks, we can also trigger a Tensorboard run as a Callback:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="o">*</span><span class="n">get_cnn_layers</span><span class="p">(</span><span class="n">raw_feat</span><span class="p">,</span> <span class="n">OUTPUT_SHAPES</span><span class="p">,</span> <span class="n">KERNELS</span><span class="p">,</span> <span class="n">STRIDES</span><span class="p">)</span>
    <span class="p">),</span> <span class="n">emb_dims</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">)</span>

<span class="n">cbfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Recorder</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">AvgStatsCallback</span><span class="p">,</span><span class="n">adjusted_accu</span><span class="p">),</span> <span class="n">partial</span><span class="p">(</span><span class="n">Tracker</span><span class="p">,</span> <span class="n">RUN_PATH</span><span class="p">)]</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span><span class="n">cb_funcs</span><span class="o">=</span><span class="n">cbfs</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">learn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 10
train: [0.6974158377017615, tensor(0.3962)]
valid: [0.6996233122689384, tensor(0.3571)]
epoch: 20
train: [0.2831651039843289, tensor(0.9434)]
valid: [0.3708829198564802, tensor(1.)]
epoch: 30
train: [0.06155696904884195, tensor(0.9811)]
valid: [0.00996389878647668, tensor(1.)]
epoch: 40
train: [0.013252086234542559, tensor(1.)]
valid: [0.00019769343946661268, tensor(1.)]
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This now has triggered a <em>run</em> for Tensorboard and saved it in this folder. We can now have a look at this by typing <em>tensorboard --logdir=runs</em> in the Terminal:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/fastpages_/images/copied_from_nb/images/Tensorboard.png" alt="Tensorboard" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And that's it for now. I hope the idea of Information Expert Principle is now a bit more familiar, and I could give you some ideas of how to refactor your existing Data Science projects.</p>
<p>Lasse</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/fastpages_/2021/10/27/How-to-use-software-engineering-to-improve-data-science.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/fastpages_/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/fastpages_/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/fastpages_/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/lschmiddey" target="_blank" title="lschmiddey"><svg class="svg-icon grey"><use xlink:href="/fastpages_/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
